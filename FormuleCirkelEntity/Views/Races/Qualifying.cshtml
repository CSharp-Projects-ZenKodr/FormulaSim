@model IEnumerable<FormuleCirkelEntity.Models.Qualification>

@{
    ViewData["Title"] = "Qualification";
    var race = ViewBag.race;
}


<h1>Qualifying in @(race.Name)</h1>
<hr />
<div class="float-right">
    <input id="two-run-check" type="checkbox" name="tworun" style="margin-right:5px; transform:scale(2);" />
    <label for="two-run-check">2-run</label>
</div>
<nav>
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <a class="nav-item nav-link active" id="nav-q1-tab" data-toggle="tab" href="#nav-q1" role="tab" aria-controls="nav-q1" aria-selected="true">Q1</a>
        <a class="nav-item nav-link" id="nav-q2-tab" data-toggle="tab" href="#nav-q2" role="tab" aria-controls="nav-q2" aria-selected="true">Q2</a>
        <a class="nav-item nav-link" id="nav-q3-tab" data-toggle="tab" href="#nav-q3" role="tab" aria-controls="nav-q3" aria-selected="true">Q3</a>
    </div>
</nav>
<div class="tab-content" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-q1" role="tabpanel" aria-labelledby="nav-q1-tab">
        <table id="graphic1" class="table table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Team</th>
                    <th>Driver</th>
                    <th>Q1</th>
                </tr>
            </thead>
            <tbody id="q1table"></tbody>
        </table>
        <button class="btn float-right" onclick="takeScreenshot('#graphic1')"><i class="fas fa-image fa-2x"></i></button>
    </div>
    <div class="tab-pane fade table-sm" id="nav-q2" role="tabpanel" aria-labelledby="nav-q2-tab">
        <table id="graphic2" class="table table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Team</th>
                    <th>Driver</th>
                    <th>Q2</th>
                </tr>
            </thead>
            <tbody id="q2table"></tbody>
        </table>
        <button class="btn float-right" onclick="takeScreenshot('#graphic2')"><i class="fas fa-image fa-2x"></i></button>
    </div>
    <div class="tab-pane fade" id="nav-q3" role="tabpanel" aria-labelledby="nav-q3-tab">
        <table id="graphic3" class="table table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Team</th>
                    <th>Driver</th>
                    <th>Q3</th>
                </tr>
            </thead>
            <tbody id="q3table"></tbody>
        </table>
        <button class="btn float-right" onclick="takeScreenshot('#graphic3')"><i class="fas fa-image fa-2x"></i></button>
    </div>
</div>

<button id="generateq1" class="btn btn-dark">Start Q1!</button>
<button id="generateq2" class="btn btn-dark">Start Q2!</button>
<button id="generateq3" class="btn btn-dark">Start Q3!</button>

<form asp-action="Return" asp-route-id="@(race.SeasonId)" asp-route-raceId="@(race.RaceId)" id="return">
    <div class="form-group">
        <input type="submit" value="Finish!" class="btn btn-dark" />
    </div>
</form>

<div id="screenshot"></div>

<script>
    $(document).ready(function () {
        var secondRun = false;
        var tworun = $("#two-run-check");
        $("#generateq2").hide();
        $("#generateq3").hide();
        $("#return").hide();
        $('#generateq1').click(function () {
            $.ajax({
                url: "Qualifying/Update",
                type: "GET",
                data: {
                    source: "Q1",
                    secondRun
                },
                success: function (drivers) {
                    if (secondRun) {
                        $("#q1table").empty();
                    }
                    $.each(drivers, function (index, driver) {
                        if (driver.position > @ViewBag.season.QualificationRemainingDriversQ2) {
                            var row = "<tr><td><span class='badge badge-danger' style='font-size:1rem;'>" + driver.position +
                                "</span></td><td><span class='badge' style='background-color:" + driver.colour + ";color:" + driver.accent + ";font-size:1rem;'>"
                                + driver.teamName + "</span></td><td>" + driver.driverName + "</td><td>" + driver.score + "</td></tr>";
                            $("#q1table").append(row);
                        } else {
                            var row = "<tr><td>" + driver.position +
                                "</td><td><span class='badge' style='background-color:" + driver.colour + ";color:" + driver.accent + ";font-size:1rem;'>"
                                + driver.teamName + "</span></td><td>" + driver.driverName + "</td><td>" + driver.score + "</td></tr>";
                            $("#q1table").append(row);
                        }
                    });
                    $('#screenshot').empty();
                    if (secondRun || tworun.is(":not(:checked)")) {
                        $("#generateq1").hide();
                        $("#generateq2").show();
                        secondRun = false;
                    } else {
                        secondRun = true;
                    }
                }
            });
        });
        $('#generateq2').click(function () {
            $.ajax({
                url: "Qualifying/Update",
                type: "GET",
                data: {
                    source: "Q2",
                    secondRun
                },
                success: function (drivers) {
                    if (secondRun) {
                        $("#q2table").empty();
                    }
                    $.each(drivers, function (index, driver) {
                        if (driver.position > @ViewBag.season.QualificationRemainingDriversQ3) {
                            var row = "<tr><td><span class='badge badge-danger' style='font-size:1rem;'>" + driver.position +
                                "</span></td><td><span class='badge' style='background-color:" + driver.colour + ";color:" + driver.accent + ";font-size:1rem;'>"
                                + driver.teamName + "</span></td><td>" + driver.driverName + "</td><td>" + driver.score + "</td></tr>";
                            $("#q2table").append(row);
                        } else {
                            var row = "<tr><td>" + driver.position +
                                "</td><td><span class='badge' style='background-color:" + driver.colour + ";color:" + driver.accent + ";font-size:1rem;'>"
                                + driver.teamName + "</span></td><td>" + driver.driverName + "</td><td>" + driver.score + "</td></tr>";
                            $("#q2table").append(row);
                        }
                    });
                    $('#screenshot').empty();
                    if (secondRun || tworun.is(":not(:checked)")) {
                        $("#generateq2").hide();
                        $("#generateq3").show();
                        secondRun = false;
                    } else {
                        secondRun = true;
                    }
                }
            });
        });
        $('#generateq3').click(function () {
            $.ajax({
                url: "Qualifying/Update",
                type: "GET",
                data: {
                    source: "Q3",
                    secondRun
                },
                success: function (drivers) {
                    if (secondRun) {
                        $("#q3table").empty();
                    }
                    $.each(drivers, function (index, driver) {
                        var row = "<tr><td>" + driver.position +
                            "</td><td><span class='badge' style='background-color:" + driver.colour + ";color:" + driver.accent + ";font-size:1rem;'>"
                            + driver.teamName + "</span></td><td>" + driver.driverName + "</td><td>" + driver.score + "</td></tr>";
                        $("#q3table").append(row);
                    });
                    $('#screenshot').empty();
                    if (secondRun || tworun.is(":not(:checked)")) {
                        $("#generateq3").hide();
                        $("#return").show();
                        secondRun = false;
                    } else {
                        secondRun = true;
                    }
                }
            });
        });
    });

    function takeScreenshot(graphicid) {
        html2canvas(document.querySelector(graphicid)).then(function (canvas) {
            $('#screenshot').empty();
            document.querySelector('#screenshot').appendChild(canvas);
        });
    }
</script>