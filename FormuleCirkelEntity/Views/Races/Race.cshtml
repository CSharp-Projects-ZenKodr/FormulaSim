@model Race
@{
    ViewData["Title"] = "Race";
}

<section class="row my-1">
    <header>
        <h1>Race: @Model.Track.Name</h1>
    </header>
</section>

<section class="row btn-group my-1">
    <a class="btn btn-primary" onclick="advanceStint()">Volgende stint</a>
</section>

<section class="row my-1">
    <table id="results" class="table table-striped">
        <thead>
            <tr>
                <th>Nummer</th>
                <th>Naam</th>
                <th>Team</th>
                @foreach (var stint in Model.Stints)
                {
                    <th>@stint.Key</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var driverResult in Model.DriverResults)
            {
                <tr data-obj-id="@driverResult.SeasonDriverId">
                    <td data-field="driverNumber">@driverResult.SeasonDriver.Driver.DriverNumber</td>
                    <td data-field="driverName">@driverResult.SeasonDriver.Driver.Name</td>
                    <td data-field="teamName">@driverResult.SeasonDriver.SeasonTeam.Team.Name</td>
                    @foreach (var stint in Model.Stints)
                    {
                        var stintResult = driverResult.StintResults.SingleOrDefault(res => res.Key == stint.Key);
                        if (stintResult.Equals(default(KeyValuePair<int, int>)))
                        {
                            stintResult = new KeyValuePair<int, int>(stint.Key, int.MinValue);
                        }
                        <td data-field="stintResult-@stintResult.Key">@(stintResult.Value == int.MinValue ? "-" : stintResult.Value.ToString())</td>
                    }
                </tr>
            }
        </tbody>
    </table>
</section>

<script>    
    const intMin = -2147483648;
    function resultOrMissing(result) {
        return (result == intMin ? "-" : result);
    }

    function processStintResponse(res) {
        let tableBody = $("#results").children("tbody");
        $.each(res.DriverResults, (resultIndex, driverResult) => {
            let row = tableBody.children("tr[data-obj-id=" + driverResult.SeasonDriverId + "]");
            $.each(driverResult.StintResults, (stintKey, stintResult) => {
                row.children("td[data-field=stintResult-" + stintKey + "]").html(resultOrMissing(stintResult));
            });
        });
    }

    function advanceStint() {
        $.ajax({
            url: "/Season/@Model.SeasonId/Races/@Model.RaceId/Advance",
            type: "POST",
            success: processStintResponse
        });
    }
</script>